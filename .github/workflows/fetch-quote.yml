name: Update quote of the day

on:
  schedule:
    - cron: '0 2 * * *' # Every day at 02:00 UTC
  push:
      branches: [main]
      paths:
      - 'scripts/get_quote.go'
      - '.github/workflows/fetch-quote.yml'
      - '.github/actions/fetch-quote/**'
  workflow_dispatch:

permissions: {}

jobs:
    get-quote:
        runs-on: ubuntu-latest
        name: Fetch and Update Quote of the Day
    
        permissions:
            contents: write

        concurrency:
            group: quote-${{ github.ref }}
            cancel-in-progress: false

        steps:
        - name: Configure monitor
          uses: GitHubSecurityLab/actions-permissions/monitor@v1

        - name: Checkout repository
          uses: actions/checkout@v6
          with:
            persist-credentials: true
    
        - name: Fetch Quote of the Day
          id: quote
          uses: ./.github/actions/fetch-quote
    
        - name: Create quote frontmatter file
          run: |
            mkdir -p content/page/quote
            cat > content/page/quote/_index.md << EOF
            ---
            title: "Today's quote"
            slug: "quote"
            layout: "quote"
            
            quote:
              image: "${{ steps.quote.outputs.image }}"
              author: "${{ steps.quote.outputs.author }}"
              text: "${{ steps.quote.outputs.quote }}"
            
            menu:
                main:
                    weight: 6
                    params: 
                        icon: quote
            ---
            EOF
    
        - name: Commit changes
          uses: stefanzweifel/git-auto-commit-action@v7
          with:
            commit_message: "chore: :hammer: Update quote"
  
        - name: Display quote in summary
          run: |
            echo "## ðŸ“… Quote of the Day Updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ${{ steps.quote.outputs.quote }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**â€” ${{ steps.quote.outputs.author }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "![Author](${{ steps.quote.outputs.image }})" >> $GITHUB_STEP_SUMMARY



    deploy:
        needs: get-quote
        name: Deploy
        permissions:
          contents: read
          pages: write
          id-token: write
        uses: nclsbayona/nclsbayona.github.io/.github/workflows/deploy.yml@main
